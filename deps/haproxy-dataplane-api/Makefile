HAPROXY_DATAPLANE_API_VERSION = v2.7
HAPROXY_DATAPLANE_API_SOURCES = https://codeload.github.com/haproxytech/dataplaneapi/tar.gz/$(HAPROXY_DATAPLANE_API_VERSION)
HAPROXY_DATAPLANE_API_TARBALL = haproxy-dataplane-$(HAPROXY_DATAPLANE_API_VERSION).tar.gz
HAPROXY_DATAPLANE_API_BUILDIR = src
HAPROXY_DATAPLANE_API_DESTDIR = dist
HAPROXY_DATAPLANE_API_ARCHIVE = haproxy-dataplane-dist.tar.gz

all: build $(HAPROXY_DATAPLANE_API_DESTDIR) $(HAPROXY_DATAPLANE_API_ARCHIVE)

$(HAPROXY_DATAPLANE_API_TARBALL):
	curl -sfS -o "$(HAPROXY_DATAPLANE_API_TARBALL)" "$(HAPROXY_DATAPLANE_API_SOURCES)"

$(HAPROXY_DATAPLANE_API_BUILDIR): $(HAPROXY_DATAPLANE_API_TARBALL)
	@if ! [ -d "$(HAPROXY_DATAPLANE_API_BUILDIR)" ]; then mkdir -v "$(HAPROXY_DATAPLANE_API_BUILDIR)"; fi
	tar -C $(HAPROXY_DATAPLANE_API_BUILDIR) --strip-components=1 -xf "$(HAPROXY_DATAPLANE_API_TARBALL)"

build: $(HAPROXY_DATAPLANE_API_BUILDIR)
	cd "$(HAPROXY_DATAPLANE_API_BUILDIR)" && \
		$(MAKE) -j "$(shell nproc)" && \
		cd ".."
	"$(HAPROXY_DATAPLANE_API_BUILDIR)/build/dataplaneapi" --version

$(HAPROXY_DATAPLANE_API_DESTDIR): build
	@if [ -d "$(HAPROXY_DATAPLANE_API_DESTDIR)" ]; then rm -rfv "$(HAPROXY_DATAPLANE_API_DESTDIR)"; fi
	cp -rfv "$(HAPROXY_DATAPLANE_API_BUILDIR)/build" "$(HAPROXY_DATAPLANE_API_DESTDIR)"

$(HAPROXY_DATAPLANE_API_ARCHIVE): $(HAPROXY_DATAPLANE_API_DESTDIR)
	tar -C "$(HAPROXY_DATAPLANE_API_DESTDIR)" -cjf "$(HAPROXY_DATAPLANE_API_ARCHIVE)" "."

clean:
	rm -fv "$(HAPROXY_DATAPLANE_API_TARBALL)"
	rm -rf "$(HAPROXY_DATAPLANE_API_BUILDIR)"
	rm -rf "$(HAPROXY_DATAPLANE_API_DESTDIR)"
	rm -fv "$(HAPROXY_DATAPLANE_API_ARCHIVE)"

.PHONY: clean build
