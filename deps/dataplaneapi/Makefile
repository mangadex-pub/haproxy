DATAPLANEAPI_VERSION = v3.0
DATAPLANEAPI_SOURCES = https://codeload.github.com/haproxytech/dataplaneapi/tar.gz/$(DATAPLANEAPI_VERSION)
DATAPLANEAPI_TARBALL = dataplaneapi-$(DATAPLANEAPI_VERSION).tar.gz
DATAPLANEAPI_BUILDIR = src
DATAPLANEAPI_DESTDIR = dist
DATAPLANEAPI_DESTDIR_ABS = $(shell realpath $(DATAPLANEAPI_DESTDIR))
DATAPLANEAPI_ARCHIVE = dataplaneapi-dist.tar.gz

BUILD_VERSION_REPOSHA = $(shell git rev-parse --short HEAD)

all: build $(DATAPLANEAPI_DESTDIR) $(DATAPLANEAPI_ARCHIVE)

$(DATAPLANEAPI_TARBALL):
	curl -fsSL -o "$(DATAPLANEAPI_TARBALL)" "$(DATAPLANEAPI_SOURCES)"

$(DATAPLANEAPI_BUILDIR): $(DATAPLANEAPI_TARBALL)
	@if ! [ -d "$(DATAPLANEAPI_BUILDIR)" ]; then mkdir -v "$(DATAPLANEAPI_BUILDIR)"; fi
	tar -C $(DATAPLANEAPI_BUILDIR) --strip-components=1 -xf "$(DATAPLANEAPI_TARBALL)"

build: $(DATAPLANEAPI_BUILDIR)
	cd "$(DATAPLANEAPI_BUILDIR)" && make \
	  GIT_HEAD_COMMIT="$(DATAPLANEAPI_VERSION)" \
	  GIT_MODIFIED="+mangadex-$(BUILD_VERSION_REPOSHA)" \
	  GIT_REPO="mangadex-pub/haproxy@git{hub, lab}"
	"$(DATAPLANEAPI_BUILDIR)/build/dataplaneapi" --version

$(DATAPLANEAPI_DESTDIR): build
	if ! [ -d "$(DATAPLANEAPI_DESTDIR)/usr/sbin" ]; then mkdir -pv "$(DATAPLANEAPI_DESTDIR)/usr/sbin"; fi
	cp -fv "$(DATAPLANEAPI_BUILDIR)/build/dataplaneapi" "$(DATAPLANEAPI_DESTDIR)/usr/sbin/dataplaneapi"

$(DATAPLANEAPI_ARCHIVE): $(DATAPLANEAPI_DESTDIR)
	tar -C "$(DATAPLANEAPI_DESTDIR)" -cjf "$(DATAPLANEAPI_ARCHIVE)" "usr"

clean:
	rm -fv "$(DATAPLANEAPI_TARBALL)"
	rm -rf "$(DATAPLANEAPI_BUILDIR)"
	rm -rf "$(DATAPLANEAPI_DESTDIR)"
	rm -fv "$(DATAPLANEAPI_ARCHIVE)"

.PHONY: clean build
